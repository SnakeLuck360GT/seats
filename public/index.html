<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>SeATs Code Scanner – Ultra Quality</title>

<style>
body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    background: #f0f0f0;
}
#controls {
    width: 90%;
    margin-bottom: 10px;
    text-align: center;
}
#qr-reader {
    width: 100%;
    max-width: 400px;
    background: black;
    overflow: hidden;
    position: relative;
}
#qr-reader video {
    transform-origin: center center;
}
#code-display {
    font-size: 1.5em;
    margin: 10px 0;
    word-break: break-word;
    text-align: center;
}
button {
    padding: 10px 20px;
    font-size: 1em;
    border: none;
    border-radius: 5px;
    margin-top: 5px;
    cursor: pointer;
}
#copy-btn { background: #007bff; color: white; }
#torch-btn { background: #ffaa00; color: black; }
#error { color: red; margin-top: 10px; text-align:center; }
</style>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<h2>SeATs Code Scanner – iPhone 17 Optimized</h2>

<div id="controls">
    <label>Zoom</label><br>
    <input type="range" id="zoom-slider" min="1" max="3" step="0.05" value="1" style="width:100%;"><br>
    <button id="torch-btn">Toggle Torch</button>
</div>

<div id="qr-reader"></div>
<div id="error"></div>
<div id="code-display"></div>
<button id="copy-btn" style="display:none;">Copy Code</button>

<script>
let globalCode = null;
let currentScale = 1;
let torchOn = false;
let track = null;

function applyZoom(scale) {
    const video = document.querySelector("#qr-reader video");
    if (video) video.style.transform = `scale(${scale})`;
}

document.getElementById("zoom-slider").addEventListener("input", function() {
    currentScale = parseFloat(this.value);
    applyZoom(currentScale);
});

document.getElementById("copy-btn").addEventListener("click", () => {
    if(globalCode) navigator.clipboard.writeText(globalCode).then(()=>alert("Code copied!"));
});

document.getElementById("torch-btn").addEventListener("click", () => {
    if(track && track.getCapabilities().torch){
        torchOn = !torchOn;
        track.applyConstraints({ advanced:[{torch: torchOn}] });
    }
});

function updateDisplay(code){
    globalCode = code;
    document.getElementById("code-display").textContent = code;
    document.getElementById("copy-btn").style.display = "inline-block";
    document.getElementById("error").textContent = "";
}

function onScanSuccess(decodedText){
    const match = decodedText.match(/^https:\/\/seatssoftware\.com\/qr\/(.+)$/);
    if(match) updateDisplay(match[1]);
    else document.getElementById("error").textContent = "Invalid QR code format!";
}

const html5Scanner = new Html5Qrcode("qr-reader");

// iPhone 17 optimized: use main rear camera, request max resolution Safari allows
const constraints = {
    facingMode: { exact: "environment" },
    width: { ideal: 3840 },
    height: { ideal: 2160 }
};

html5Scanner.start(
    constraints,
    { fps:10, qrbox:250 },
    onScanSuccess
).then(() => {
    // grab the video track for torch and autofocus
    const stream = document.querySelector("#qr-reader video").srcObject;
    if(stream) track = stream.getVideoTracks()[0];

    // apply initial digital zoom
    setTimeout(()=>applyZoom(currentScale), 500);
}).catch(err=>{
    document.getElementById("error").textContent = "Camera failed: "+err;
});
</script>

</body>
</html>
