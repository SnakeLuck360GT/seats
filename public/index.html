<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid QR Scanner</title>

<style>
    body {
        font-family: Arial;
        padding: 20px;
        text-align: center;
        background: #f0f0f0;
    }
    #qr-reader {
        width: 95%;
        max-width: 480px;
        margin: auto;
        background: black;
        border-radius: 10px;
        overflow: hidden;
    }
    #qr-reader video {
        transform-origin: center;
    }
    #fallbackBtn {
        margin-top: 15px;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        background: #ff9900;
        color: white;
        cursor: pointer;
    }
    #fileInput {
        display: none;
    }
    #preview {
        display: none;
        width: 95%;
        max-width: 480px;
        border-radius: 10px;
        margin-top: 15px;
    }
    #result {
        margin-top: 20px;
        font-size: 1.4em;
        word-break: break-word;
    }
    #error {
        color: red;
        margin-top: 10px;
    }
</style>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

</head>
<body>

<h2>Hybrid QR Scanner</h2>

<!-- LIVE SCANNER -->
<div id="qr-reader"></div>

<!-- BUTTON TO CAPTURE A HIGH-RES PHOTO -->
<button id="fallbackBtn">Scan From Far Away (Hi-Res Mode)</button>
<input type="file" accept="image/*" capture="environment" id="fileInput">

<!-- Hi-res photo preview (optional) -->
<img id="preview">

<div id="result"></div>
<div id="error"></div>

<script>
const fallbackBtn = document.getElementById("fallbackBtn");
const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");
const resultBox = document.getElementById("result");
const errorBox = document.getElementById("error");

function showError(msg) {
    errorBox.textContent = msg;
}

function showResult(code) {
    resultBox.textContent = code;
    errorBox.textContent = "";
}

// ----------------------
// 1️⃣ LIVE SCANNER SETUP
// ----------------------
function liveScan() {
    const qrScanner = new Html5Qrcode("qr-reader");

    qrScanner.start(
        { facingMode: "environment" },
        { fps: 15, qrbox: 250 },
        (decoded) => {
            const match = decoded.match(/^https:\/\/seatssoftware\.com\/qr\/(.+)$/);
            if (match) showResult(match[1]);
        },
        () => {}
    ).catch(err => showError("Camera error: " + err));
}

liveScan();

// ----------------------------------------------------
// 2️⃣ HI-RES FALLBACK: TAKE PHOTO → ZXING DECODE
// ----------------------------------------------------
fallbackBtn.onclick = () => fileInput.click();

fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file) return;

    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";

    preview.onload = () => decodeHighRes(preview);
};

async function decodeHighRes(img) {
    try {
        const code = await ZXing.BrowserQRCodeReader.decodeFromImage(img);
        const text = code.text;

        const match = text.match(/^https:\/\/seatssoftware\.com\/qr\/(.+)$/);

        if (match) showResult(match[1]);
        else showError("Invalid QR format");
    } catch (e) {
        showError("Couldn't read QR. Try closer / tap to focus / more light.");
    }
}
</script>

</body>
</html>
