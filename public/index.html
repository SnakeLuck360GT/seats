<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeATs Code</title>
<style>
body { font-family: Arial; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f0f0f0; }
#qr-reader { width: 100%; max-width: 400px; margin-bottom: 20px; }
#code-display { font-size: 1.5em; margin: 10px 0; word-break: break-word; text-align: center; }
button { padding: 10px 20px; font-size: 1em; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
button:hover { background-color: #0056b3; }
#error { color: red; margin-top: 10px; }
</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<h1>SeATs Code</h1>
<div id="qr-reader"></div>
<div id="error"></div>
<div id="code-display"></div>
<button id="copy-btn" style="display:none;">Copy Code</button>

<script>
let globalCode = null;

function updateDisplay(code) {
  globalCode = code;
  document.getElementById('code-display').textContent = code;
  document.getElementById('copy-btn').style.display = 'inline-block';
  document.getElementById('error').textContent = '';
}

document.getElementById('copy-btn').addEventListener('click', () => {
  if(globalCode){
    navigator.clipboard.writeText(globalCode).then(() => alert('Code copied!'));
  }
});

async function fetchGlobalCode() {
  try {
    const res = await fetch('/.netlify/functions/get-code');
    const data = await res.json();
    if(data.code) updateDisplay(data.code);
  } catch(e) { console.log('Could not fetch global code'); }
}

async function sendGlobalCode(code) {
  try {
    await fetch('/.netlify/functions/set-code', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ code })
    });
  } catch(e) { console.log('Could not send code'); }
}

function onScanSuccess(decodedText) {
  const errorDiv = document.getElementById('error');
  const match = decodedText.match(/^https:\/\/seatssoftware\.com\/qr\/(.+)$/);
  if(match){
    const code = match[1];
    updateDisplay(code);
    sendGlobalCode(code);
  } else {
    errorDiv.textContent = 'Invalid QR code format!';
  }
}

let html5QrcodeScanner = new Html5Qrcode("qr-reader");
html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);

fetchGlobalCode();
</script>

</body>
</html>
